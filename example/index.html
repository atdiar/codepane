<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Code Pane Demo</title>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" rel="stylesheet">
  <style>
    * { box-sizing: border-box; }
    body {
      margin: 0;
      padding: 20px;
      font-family: system-ui, -apple-system, sans-serif;
      background: #f5f5f5;
      min-height: 100vh;
    }
    h1 { margin: 0 0 20px; font-size: 1.5rem; }
    .controls {
      margin-bottom: 16px;
      display: flex;
      gap: 12px;
      align-items: center;
    }
    .controls button {
      padding: 8px 16px;
      border: 1px solid #ccc;
      border-radius: 4px;
      background: white;
      cursor: pointer;
      font-size: 14px;
    }
    .controls button:hover { background: #eee; }
    .controls button.active { background: #007bff; color: white; border-color: #007bff; }
    .pane-container {
      display: flex;
      gap: 20px;
      height: 500px;
    }
    .pane-wrapper {
      flex: 1;
      display: flex;
      flex-direction: column;
      background: white;
      border: 1px solid #ddd;
      border-radius: 8px;
      overflow: hidden;
    }
    .pane-header {
      padding: 10px 14px;
      background: #f8f8f8;
      border-bottom: 1px solid #ddd;
      font-weight: 600;
      font-size: 14px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .pane-header .lang-tag {
      font-size: 12px;
      padding: 2px 8px;
      background: #e0e0e0;
      border-radius: 4px;
      font-weight: normal;
    }
    .pane-host {
      flex: 1;
      position: relative;
      overflow: hidden;
    }
    .diagnostics-panel {
      margin-top: 20px;
      padding: 16px;
      background: white;
      border: 1px solid #ddd;
      border-radius: 8px;
    }
    .diagnostics-panel h3 {
      margin: 0 0 12px;
      font-size: 14px;
    }
    .diagnostics-panel ul {
      margin: 0;
      padding: 0 0 0 20px;
      font-family: ui-monospace, monospace;
      font-size: 13px;
    }
    .diagnostics-panel li { color: #c00; margin-bottom: 4px; }
    .diagnostics-panel .no-errors { color: #080; }

    /* ==================== Code Pane Styles ==================== */
    /* 
     * Structure mirrors the original:
     * - Textarea on top (z-index 1), transparent text, visible caret
     * - Highlight div behind (z-index 0), shows syntax + error backgrounds
     * - Line numbers absolutely positioned
     */
    .code-pane {
      position: relative;
      height: 100%;
      background: #fafafa;
    }

    .code-pane__lines {
      position: absolute;
      left: 0;
      top: 0;
      width: 40px;
      height: 100%;
      padding: 10px 5px;
      background-color: #f0f0f0;
      border-right: 1px solid #ccc;
      text-align: right;
      font-family: 'Courier New', Courier, monospace;
      font-size: 13px;
      line-height: 1.5;
      color: #999;
      user-select: none;
      overflow: hidden;
      pointer-events: none;
      z-index: 2;
    }

    .code-pane__body {
      position: relative;
      height: 100%;
      overflow: hidden;
    }

    /* Textarea and highlight share IDENTICAL styling */
    .code-pane__editor,
    .code-pane__highlight {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      margin: 0;
      padding: 10px;
      padding-left: 50px;
      font-family: 'Courier New', Courier, monospace;
      font-size: 13px;
      line-height: 1.5;
      border: none;
      white-space: pre;
      word-wrap: break-word;
      box-sizing: border-box;
      overflow: hidden;
      width: 100%;
      height: 100%;
      tab-size: 4;
      -moz-tab-size: 4;
    }

    .code-pane__editor {
      background: transparent;
      color: transparent;
      caret-color: black;
      z-index: 1;
      resize: none;
      outline: none;
    }

    .code-pane__editor:hover,
    .code-pane__editor:focus {
      overflow: auto;
    }

    .code-pane__viewer {
      color: transparent;
      background: transparent;
      cursor: default;
    }

    .code-pane__viewer:hover {
      overflow: auto;
    }

    .code-pane__highlight {
      z-index: 0;
      pointer-events: none;
      color: #333;  /* Base text color - dark gray */
      background-color: transparent;
    }

    /* Ensure Prism tokens have readable colors on light background */
    .code-pane__highlight .token.comment,
    .code-pane__highlight .token.prolog,
    .code-pane__highlight .token.doctype,
    .code-pane__highlight .token.cdata {
      color: #708090;
    }
    .code-pane__highlight .token.punctuation {
      color: #333;
    }
    .code-pane__highlight .token.property,
    .code-pane__highlight .token.tag,
    .code-pane__highlight .token.boolean,
    .code-pane__highlight .token.number,
    .code-pane__highlight .token.constant,
    .code-pane__highlight .token.symbol {
      color: #905;
    }
    .code-pane__highlight .token.selector,
    .code-pane__highlight .token.attr-name,
    .code-pane__highlight .token.string,
    .code-pane__highlight .token.char,
    .code-pane__highlight .token.builtin {
      color: #690;
    }
    .code-pane__highlight .token.operator,
    .code-pane__highlight .token.entity,
    .code-pane__highlight .token.url,
    .code-pane__highlight .token.variable {
      color: #9a6e3a;
    }
    .code-pane__highlight .token.atrule,
    .code-pane__highlight .token.attr-value,
    .code-pane__highlight .token.keyword {
      color: #07a;
    }
    .code-pane__highlight .token.function,
    .code-pane__highlight .token.class-name {
      color: #DD4A68;
    }
    .code-pane__highlight .token.regex,
    .code-pane__highlight .token.important {
      color: #e90;
    }

    /* Error line backgrounds */
    .code-pane__errline {
      display: block;
      width: 100%;
    }
    .code-pane__errline--on {
      background-color: #ffcccc;
    }
  </style>
</head>
<body>
  <h1>Code Pane Demo</h1>
  
  <div class="controls">
    <button id="toggleReadonly">Toggle Readonly</button>
    <button id="insertError">Insert Syntax Error</button>
    <button id="resetCode">Reset Code</button>
    <span id="readonlyStatus" style="font-size: 14px; color: #666;">Mode: Editable</span>
  </div>

  <div class="pane-container">
    <div class="pane-wrapper">
      <div class="pane-header">
        <span>JavaScript Editor</span>
        <span class="lang-tag">JS</span>
      </div>
      <div class="pane-host" id="jsHost"></div>
    </div>
    <div class="pane-wrapper">
      <div class="pane-header">
        <span>Output Preview</span>
        <span class="lang-tag">Read-only</span>
      </div>
      <div class="pane-host" id="outputHost"></div>
    </div>
  </div>

  <div class="diagnostics-panel">
    <h3>Diagnostics</h3>
    <ul id="diagnosticsList">
      <li class="no-errors">No errors</li>
    </ul>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-javascript.min.js"></script>
  <script type="module">
    import { createCodePane } from './createCodePane.js';

    const initialJS = `// Code Pane Demo - JavaScript Example
function createCodePane(options = {}) {
	const {
		value = '',
		language = '',
		indent = '\\t',
		readonly = false,
		showLineNumbers = true,
		enableOverlay = true,
	} = options;

	// Create DOM structure
	const root = document.createElement('div');
	root.className = 'code-pane';

	const textarea = document.createElement('textarea');
	textarea.className = 'code-pane__editor';
	textarea.spellcheck = false;
	textarea.value = value;

	// Utility functions
	const escapeHtml = (str) => {
		return str
			.replace(/&/g, '&amp;')
			.replace(/</g, '&lt;')
			.replace(/>/g, '&gt;');
	};

	const refresh = () => {
		const text = textarea.value;
		const lines = text.split('\\n');
		renderLineNumbers(lines.length);
		renderSyntax(text);
	};

	return {
		root,
		getValue: () => textarea.value,
		setValue: (text) => {
			textarea.value = text;
			refresh();
		},
		refresh,
	};
}

// Example usage
const pane = createCodePane({
	value: 'console.log("Hello, World!");',
	language: 'javascript',
});

document.body.appendChild(pane.root);
`;

    // Simple JS validator
    function validateJS(text) {
      const errors = [];
      const lines = text.split('\n');
      
      let braceDepth = 0;
      let parenDepth = 0;
      let bracketDepth = 0;
      
      lines.forEach((line, i) => {
        const lineNum = i + 1;
        const trimmed = line.trim();
        
        if (trimmed.startsWith('//')) return;
        
        for (const ch of line) {
          if (ch === '{') braceDepth++;
          if (ch === '}') braceDepth--;
          if (ch === '(') parenDepth++;
          if (ch === ')') parenDepth--;
          if (ch === '[') bracketDepth++;
          if (ch === ']') bracketDepth--;
        }
        
        if (trimmed.includes('cosnt ')) {
          errors.push({ lineNumber: lineNum, message: `Typo: 'cosnt' should be 'const'` });
        }
        if (trimmed.includes('fucntion ') || trimmed.includes('funtion ')) {
          errors.push({ lineNumber: lineNum, message: `Typo: misspelled 'function'` });
        }
      });
      
      if (braceDepth !== 0) {
        errors.push({ lineNumber: lines.length, message: `Unbalanced braces (depth: ${braceDepth})` });
      }
      if (parenDepth !== 0) {
        errors.push({ lineNumber: lines.length, message: `Unbalanced parentheses (depth: ${parenDepth})` });
      }
      if (bracketDepth !== 0) {
        errors.push({ lineNumber: lines.length, message: `Unbalanced brackets (depth: ${bracketDepth})` });
      }
      
      return errors;
    }

    // Syntax highlighter using Prism
    const syntaxToHtml = (text, lang) => {
      const grammar = Prism.languages[lang] || Prism.languages.javascript;
      return Prism.highlight(text, grammar, lang || 'javascript');
    };

    let isReadonly = false;
    const diagnosticsList = document.getElementById('diagnosticsList');
    const readonlyStatus = document.getElementById('readonlyStatus');

    function updateDiagnosticsDisplay(diagnostics) {
      if (!diagnostics || diagnostics.length === 0) {
        diagnosticsList.innerHTML = '<li class="no-errors">No errors</li>';
      } else {
        diagnosticsList.innerHTML = diagnostics
          .map(d => `<li>Line ${d.lineNumber}: ${d.message}</li>`)
          .join('');
      }
    }

    // Create readonly output pane first
    const outputPane = createCodePane({
      value: initialJS,
      language: 'javascript',
      readonly: true,
      readonlyRenderer: 'pre',
      syntaxToHtml,
      showLineNumbers: true,
      enableOverlay: true
    });

    // Create main editor pane
    const jsPane = createCodePane({
      value: initialJS,
      language: 'javascript',
      readonly: false,
      readonlyRenderer: 'pre',
      validate: validateJS,
      syntaxToHtml,
      onChange: (text, { diagnostics }) => {
        updateDiagnosticsDisplay(diagnostics);
        outputPane.setValue(text);
      }
    });

    document.getElementById('jsHost').appendChild(jsPane.root);
    document.getElementById('outputHost').appendChild(outputPane.root);

    updateDiagnosticsDisplay(validateJS(initialJS));

    document.getElementById('toggleReadonly').addEventListener('click', () => {
      isReadonly = !isReadonly;
      jsPane.setReadonly(isReadonly);
      readonlyStatus.textContent = `Mode: ${isReadonly ? 'Readonly' : 'Editable'}`;
      document.getElementById('toggleReadonly').classList.toggle('active', isReadonly);
    });

    document.getElementById('insertError').addEventListener('click', () => {
      const current = jsPane.getValue();
      const errorJS = current + `\n\n// Intentional errors below:\ncosnt broken = "typo";\nfuntion oops() {\n\treturn 42\n`;
      jsPane.setValue(errorJS);
    });

    document.getElementById('resetCode').addEventListener('click', () => {
      jsPane.setValue(initialJS);
    });
  </script>
</body>
</html>
